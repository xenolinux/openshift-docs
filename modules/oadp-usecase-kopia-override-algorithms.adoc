// Module included in the following assemblies:
//
// * backup_and_restore/application_backup_and_restore/installing/overriding-kopia-algorithms.adoc

:_mod-docs-content-type: PROCEDURE
[id="oadp-usecase-kopia-override-algorithms_{context}"]
= Use case for overriding Kopia hashing, encryption, and splitter algorithms

[role="_abstract"]
Back up an application by using Kopia environment variables for hashing, encryption, and splitter. Store the backup in an {aws-short} S3 bucket and verify the environment variables by connecting to the Kopia repository.

.Prerequisites

* You have installed the {oadp-short} Operator.
* You have an AWS S3 bucket configured as the backup storage location.
* You have created the secret by using the credentials provided by the cloud provider.
* You have installed the Kopia client.
* You have an application with persistent volumes running in a separate namespace.

.Procedure

. Configure the Data Protection Application (DPA) as shown in the following example:
+
[source,yaml]
----
apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
name: <dpa_name>
namespace: openshift-adp
spec:
backupLocations:
- name: aws
  velero:
    config:
      profile: default
      region: <region_name>
    credential:
      key: cloud
      name: cloud-credentials
    default: true
    objectStorage:
      bucket: <bucket_name>
      prefix: velero
    provider: aws
configuration:
  nodeAgent:
    enable: true
    uploaderType: kopia
  velero:
    defaultPlugins:
    - openshift
    - aws
    - csi
    defaultSnapshotMoveData: true
    podConfig:
      env:
        - name: KOPIA_HASHING_ALGORITHM
          value: BLAKE3-256
        - name: KOPIA_ENCRYPTION_ALGORITHM
          value: CHACHA20-POLY1305-HMAC-SHA256
        - name: KOPIA_SPLITTER_ALGORITHM
          value: DYNAMIC-8M-RABINKARP
----
+
where:
+
`<dpa_name>`:: Specifies a name for the DPA.
`<region_name>`:: Specifies the region for the backup storage location.
`cloud-credentials`:: Specifies the name of the default `Secret` object.
`<bucket_name>`:: Specifies the AWS S3 bucket name.
`csi`:: Include the `csi` plugin.
`BLAKE3-256`:: Specifies the hashing algorithm as `BLAKE3-256`.
`CHACHA20-POLY1305-HMAC-SHA256`:: Specifies the encryption algorithm as `CHACHA20-POLY1305-HMAC-SHA256`.
`DYNAMIC-8M-RABINKARP`:: Specifies the splitter algorithm as `DYNAMIC-8M-RABINKARP`.

. Create the DPA by running the following command:
+
[source,terminal]
----
$ oc create -f <dpa_file_name>
----
Replace `<dpa_file_name>` with the file name of the DPA you configured.

. Verify that the DPA has reconciled by running the following command:
+
[source,terminal]
----
$ oc get dpa -o yaml
----

. Create a `Backup` CR as shown in the following example:
+
[source,yaml]
----
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: test-backup
  namespace: openshift-adp
spec:
  includedNamespaces:
  - <application_namespace>
  defaultVolumesToFsBackup: true
----
Replace `<application_namespace>` with the namespace for the application installed in the cluster.

. Create a backup by running the following command:
+
[source,terminal]
----
$ oc apply -f <backup_file_name>
----
Replace `<backup_file_name>` with the name of the `Backup` CR file.

. Verify that the backup completed by running the following command:
+
[source,terminal]
----
$ oc get backups.velero.io <backup_name> -o yaml
----
Replace `<backup_name>` with the name of the backup.

.Verification

. Connect to the Kopia repository by running the following command:
+
[source,terminal]
----
$ kopia repository connect s3 \
  --bucket=<bucket_name> \
  --prefix=velero/kopia/<application_namespace> \
  --password=static-passw0rd \
  --access-key="<aws_s3_access_key>" \
  --secret-access-key="<aws_s3_secret_access_key>" \
----
+
where:
+
`<bucket_name>`:: Specifies the AWS S3 bucket name.
`<application_namespace>`:: Specifies the namespace for the application.
`static-passw0rd`:: This is the Kopia password to connect to the repository.
`<aws_s3_access_key>`:: Specifies the AWS S3 access key.
`<aws_s3_secret_access_key>`:: Specifies the AWS S3 storage provider secret access key.
+
[NOTE]
====
If you are using a storage provider other than AWS S3, you will need to add `--endpoint`, the bucket endpoint URL parameter, to the command.
====

. Verify that Kopia uses the environment variables that are configured in the DPA for the backup by running the following command:
+
[source,terminal]
----
$ kopia repository status
----
+
.Example output
[source,terminal]
----
Config file:         /../.config/kopia/repository.config

Description:         Repository in S3: s3.amazonaws.com <bucket_name>
# ...

Storage type:        s3
Storage capacity:    unbounded
Storage config:      {
                       "bucket": <bucket_name>,
                       "prefix": "velero/kopia/<application_namespace>/",
                       "endpoint": "s3.amazonaws.com",
                       "accessKeyID": <access_key>,
                       "secretAccessKey": "****************************************",
                       "sessionToken": ""
                     }

Unique ID:           58....aeb0
Hash:                BLAKE3-256
Encryption:          CHACHA20-POLY1305-HMAC-SHA256
Splitter:            DYNAMIC-8M-RABINKARP
Format version:      3
# ...
----
